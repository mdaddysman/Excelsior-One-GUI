
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>ExcelsiorOne</title><meta name="generator" content="MATLAB 8.4"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2015-07-22"><meta name="DC.source" content="ExcelsiorOne.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><pre class="codeinput"><span class="keyword">function</span> ExcelsiorOne()
<span class="comment">%check to see if the port settings are set</span>
<span class="keyword">if</span> exist(<span class="string">'ports.mat'</span>, <span class="string">'file'</span>) == 2
    ports = load(<span class="string">'ports.mat'</span>);
    LoadGUI(ports.ports);
<span class="keyword">else</span>
    SelectPorts();
<span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> LoadGUI(ports)
fh = figure(<span class="string">'Name'</span>,<span class="string">'Spectra-Physics Excelsior One Control'</span>,<span class="string">'NumberTitle'</span>,<span class="string">'off'</span>);
set(fh,<span class="string">'Resize'</span>,<span class="string">'off'</span>,<span class="string">'Position'</span>,[50 50 600 300],<span class="string">'MenuBar'</span>,<span class="string">'none'</span>,<span class="string">'ToolBar'</span>,<span class="string">'none'</span>);
ah = axes;
set(ah,<span class="string">'Visible'</span>,<span class="string">'off'</span>,<span class="string">'Position'</span>,[0 0 1 1],<span class="string">'Xlim'</span>,[0 600],<span class="string">'Ylim'</span>,[0 300]);
mh = uimenu(fh,<span class="string">'Label'</span>,<span class="string">'Options'</span>);
moh(1) = uimenu(mh,<span class="string">'Label'</span>,<span class="string">'Options'</span>);
moh(2) = uimenu(mh,<span class="string">'Label'</span>,<span class="string">'Save Powers'</span>);



<span class="comment">%Open the COM ports</span>
<span class="comment">%Get the wavelength, min and max powers for each laser</span>
<span class="keyword">for</span> m=1:4
    pn = char(ports(m));
    <span class="keyword">if</span>(strcmp(pn,<span class="string">'COM0'</span>) ~= 1)
        obj = OpenPort(pn);
        r = WritePort(obj,<span class="string">'?WAVE'</span>);
        wl = str2double(r(6:end));
        WritePort(obj,<span class="string">'LD=0'</span>); <span class="comment">%start with laser off</span>
        <span class="keyword">if</span>(m == 3)
            MinPwr = 50;
        <span class="keyword">else</span>
            r = WritePort(obj,<span class="string">'?MINLP'</span>);
            MinPwr = str2double(r(7:end));
        <span class="keyword">end</span>
        r = WritePort(obj,<span class="string">'?MAXLP'</span>);
        MaxPwr = str2double(r(7:end));
        r = WritePort(obj,<span class="string">'?SP'</span>);
        Pwr = str2double(r(4:end));
    <span class="keyword">else</span>
        wl = 0; <span class="comment">%change to read from COM</span>
        obj = serial(<span class="string">'COM1'</span>);
        MinPwr = 0; MaxPwr = 100; Pwr = 100;
    <span class="keyword">end</span>
    nh = uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,{[pn <span class="string">':'</span>],[num2str(wl) <span class="string">' nm'</span>]},<span class="string">'Position'</span>,[5+150*(m-1) 255 140 40],<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    bh = uicontrol(<span class="string">'Style'</span>,<span class="string">'togglebutton'</span>,<span class="string">'String'</span>,<span class="string">'Laser Off'</span>,<span class="string">'Position'</span>,[25+150*(m-1) 240 100 20],<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8],<span class="string">'Callback'</span>,{@LaserOnOff,m,obj});
    cpth(m) = uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,[<span class="string">'Power: '</span> num2str(Pwr) <span class="string">' mW'</span>],<span class="string">'Position'</span>,[5+150*(m-1) 215 140 20],<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    pth = uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,[num2str(Pwr) <span class="string">' mW'</span>],<span class="string">'Position'</span>,[25+150*(m-1) 72 60 20],<span class="string">'FontSize'</span>,10);
    sph = uicontrol(<span class="string">'Style'</span>,<span class="string">'slider'</span>,<span class="string">'Position'</span>,[90+150*(m-1) 30 30 180],<span class="string">'Min'</span>,MinPwr,<span class="string">'Max'</span>,MaxPwr,<span class="string">'Value'</span>,Pwr,<span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8],<span class="string">'Callback'</span>,{@ChangePower,pth,obj});
    mapth = uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,[num2str(MaxPwr) <span class="string">' mW'</span>],<span class="string">'Position'</span>,[25+150*(m-1) 190 60 20],<span class="string">'FontSize'</span>,10);
    mipth = uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,[num2str(MinPwr) <span class="string">' mW'</span>],<span class="string">'Position'</span>,[25+150*(m-1) 25 60 20],<span class="string">'FontSize'</span>,10);
    tth(m) = uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'Temp: 25 C'</span>,<span class="string">'Position'</span>,[5+150*(m-1) 2 140 20],<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    <span class="keyword">if</span>(strcmp(pn,<span class="string">'COM0'</span>) == 1)
        set(nh,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
        set(bh,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
        set(pth,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
        set(cpth,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
        set(sph,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
        set(mapth,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
        set(mipth,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
        set(tth(m),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
    <span class="keyword">end</span>
    rh.sph(m) = sph;
    rh.wl(m) = wl;

    rh.obj(m) = obj;

<span class="keyword">end</span>
rh.pn = ports;
set(moh(1),<span class="string">'Callback'</span>,{@OptionsBox,rh});
set(fh,<span class="string">'CloseRequestFcn'</span>,{@CloseGUI,fh,rh});
moh(3) = uimenu(mh,<span class="string">'Label'</span>,<span class="string">'Select Ports'</span>,<span class="string">'Callback'</span>,{@SelectNewPorts,fh,rh});
moh(3).Separator = <span class="string">'on'</span>;
moh(4) = uimenu(mh,<span class="string">'Label'</span>,<span class="string">'Exit'</span>,<span class="string">'Callback'</span>,{@CloseGUI,fh,rh});
moh(4).Separator = <span class="string">'on'</span>;
<span class="keyword">for</span> m=1:3
    line([1+150*(m) 3+150*(m)], [0 300], <span class="string">'Parent'</span>, ah,<span class="string">'Color'</span>,[0 0 0]);
<span class="keyword">end</span>

<span class="keyword">while</span>(ishghandle(fh))
    <span class="keyword">for</span> m=1:4
        <span class="keyword">if</span>(strcmp(char(ports(m)),<span class="string">'COM0'</span>) ~= 1)
            <span class="comment">%update temperature</span>
            r = WritePort(rh.obj(m),<span class="string">'?DT'</span>);
            <span class="keyword">if</span>(str2double(r(end-3:end)) &gt; 50)
                set(tth(m),<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
            <span class="keyword">else</span>
                set(tth(m),<span class="string">'ForegroundColor'</span>,<span class="string">'k'</span>);
            <span class="keyword">end</span>
            set(tth(m),<span class="string">'String'</span>,[<span class="string">'Temp: '</span> r(end-3:end) <span class="string">' C'</span>]);
            r = WritePort(rh.obj(m),<span class="string">'?P'</span>);
            set(cpth(m),<span class="string">'String'</span>,[<span class="string">'Power: '</span> num2str(r(3:end)) <span class="string">' mW'</span>]);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    pause(2);
<span class="keyword">end</span>

<span class="keyword">end</span>

<span class="keyword">function</span> ChangePower(src,~,pth,obj)
val = get(src,<span class="string">'Value'</span>);
val = round(val*10)/10;
set(pth,<span class="string">'String'</span>,[num2str(val) <span class="string">' mW'</span>]);
set(src,<span class="string">'Value'</span>,val);
WritePort(obj,[<span class="string">'SP='</span> num2str(val)]);
<span class="keyword">end</span>

<span class="keyword">function</span> LaserOnOff(src,~,num,obj)
onoff = get(src,<span class="string">'Value'</span>);

<span class="keyword">if</span>(onoff == 1) <span class="comment">%if off turn on</span>
    <span class="keyword">switch</span> num
        <span class="keyword">case</span> 1
            set(src,<span class="string">'String'</span>,<span class="string">'Laser On'</span>,<span class="string">'BackgroundColor'</span>,[0.63 0 1],<span class="string">'ForegroundColor'</span>,<span class="string">'w'</span>);
        <span class="keyword">case</span> 2
            set(src,<span class="string">'String'</span>,<span class="string">'Laser On'</span>,<span class="string">'BackgroundColor'</span>,<span class="string">'c'</span>,<span class="string">'ForegroundColor'</span>,<span class="string">'k'</span>);
        <span class="keyword">case</span> 3
            set(src,<span class="string">'String'</span>,<span class="string">'Laser On'</span>,<span class="string">'BackgroundColor'</span>,<span class="string">'g'</span>,<span class="string">'ForegroundColor'</span>,<span class="string">'k'</span>);
        <span class="keyword">case</span> 4
            set(src,<span class="string">'String'</span>,<span class="string">'Laser On'</span>,<span class="string">'BackgroundColor'</span>,<span class="string">'r'</span>,<span class="string">'ForegroundColor'</span>,<span class="string">'w'</span>);
    <span class="keyword">end</span>
    WritePort(obj,<span class="string">'LD=1'</span>);
<span class="keyword">else</span>
    set(src,<span class="string">'String'</span>,<span class="string">'Laser Off'</span>,<span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8],<span class="string">'ForegroundColor'</span>,<span class="string">'k'</span>);
    WritePort(obj,<span class="string">'LD=0'</span>);
<span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> CloseGUI(~,~,fh,rh)
<span class="comment">%put a test if you want to save powers later</span>
choice = questdlg(<span class="string">'Do you want to exit?'</span>,<span class="string">'Confirm Exit'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
<span class="keyword">switch</span> choice
    <span class="keyword">case</span> <span class="string">'Yes'</span>
        <span class="keyword">for</span> m=1:4
            <span class="keyword">if</span>(strcmp(char(rh.pn(m)),<span class="string">'COM0'</span>) ~= 1)
                WritePort(rh.obj(m),<span class="string">'LD=0'</span>);
                ClosePort(rh.obj(m));
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        delete(fh);
    <span class="keyword">case</span> <span class="string">'No'</span>
        <span class="keyword">return</span>
<span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> SelectNewPorts(~,~,fh,rh)
choice = questdlg({<span class="string">'Do you want to select new ports?'</span>,<span class="string">'(Lasers will be turned off)'</span>},<span class="string">'Confirm Port Selection'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
<span class="keyword">switch</span> choice
    <span class="keyword">case</span> <span class="string">'Yes'</span>
        <span class="keyword">for</span> m=1:4
            <span class="keyword">if</span>(strcmp(char(rh.pn(m)),<span class="string">'COM0'</span>) ~= 1)
                WritePort(rh.obj(m),<span class="string">'LD=0'</span>);
                ClosePort(rh.obj(m));
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        delete(fh);
        SelectPorts();
    <span class="keyword">case</span> <span class="string">'No'</span>
        <span class="keyword">return</span>
<span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> OptionsBox(~,~,rh)
fh = figure(<span class="string">'Name'</span>,<span class="string">'Options'</span>,<span class="string">'NumberTitle'</span>,<span class="string">'off'</span>);
set(fh,<span class="string">'Resize'</span>,<span class="string">'off'</span>,<span class="string">'Position'</span>,[100 350 600 300],<span class="string">'MenuBar'</span>,<span class="string">'none'</span>,<span class="string">'ToolBar'</span>,<span class="string">'none'</span>,<span class="string">'CloseRequestFcn'</span>,{@CloseOptions,fh});
ah = axes;
set(ah,<span class="string">'Visible'</span>,<span class="string">'off'</span>,<span class="string">'Position'</span>,[0 0 1 1],<span class="string">'Xlim'</span>,[0 600],<span class="string">'Ylim'</span>,[0 300]);


<span class="keyword">for</span> m=1:4
    pn = char(rh.pn(m));
    <span class="keyword">if</span>(strcmp(pn,<span class="string">'COM0'</span>) ~= 1)
        r = WritePort(rh.obj(m),<span class="string">'?C'</span>);
        current = str2double(r(3:end)); <span class="comment">%get current</span>
        r = WritePort(rh.obj(m),<span class="string">'?HH'</span>);
        hours = str2double(r(4:end)); <span class="comment">%get run hours</span>
        r = WritePort(rh.obj(m),<span class="string">'?CDRH'</span>);
        cdrh = str2double(r(end)); <span class="comment">%get cdrh setting</span>
        <span class="keyword">if</span>(m ~= 3)
            r = WritePort(rh.obj(m),<span class="string">'?PM'</span>);
            dm = str2double(r(end)); <span class="comment">%get digitial modulation setting</span>
        <span class="keyword">else</span>
            dm = 0;<span class="comment">%always zero and off for dpss</span>
        <span class="keyword">end</span>
        r = WritePort(rh.obj(m),<span class="string">'?DST'</span>);
        settemp = str2double(r(5:end)); <span class="comment">%get cdrh setting</span>
    <span class="keyword">else</span>
        <span class="comment">%all zeros</span>
        current = 0; hours = 0; cdrh = 0; dm = 0; settemp = 0;
    <span class="keyword">end</span>

    nh = uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,{[pn <span class="string">':'</span>],[num2str(rh.wl(m)) <span class="string">' nm'</span>],[<span class="string">'Run Hours: '</span> num2str(hours)],[<span class="string">'Current: '</span> num2str(current) <span class="string">' mA'</span> ],[<span class="string">'Set Temp: '</span> num2str(settemp) <span class="string">'C'</span>]},<span class="string">'Position'</span>,[5+150*(m-1) 195 140 100],<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    cdrhbh = uicontrol(<span class="string">'Style'</span>,<span class="string">'checkbox'</span>,<span class="string">'String'</span>,<span class="string">'Five Second Delay'</span>,<span class="string">'Position'</span>,[5+150*(m-1) 155 140 40],<span class="string">'FontSize'</span>,10,<span class="string">'Value'</span>,cdrh,<span class="string">'Callback'</span>,{@SetCDRH,rh.obj(m)});
    dmbh = uicontrol(<span class="string">'Style'</span>,<span class="string">'checkbox'</span>,<span class="string">'String'</span>,<span class="string">'Digital Modulation'</span>,<span class="string">'Position'</span>,[5+150*(m-1) 105 140 40],<span class="string">'FontSize'</span>,10,<span class="string">'Value'</span>,dm,<span class="string">'Callback'</span>,{@SetDM,rh.obj(m)});

    <span class="keyword">if</span>(strcmp(pn,<span class="string">'COM0'</span>) == 1)
        set(nh,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
        set(cdrhbh,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
        set(dmbh,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
    <span class="keyword">end</span>
    <span class="keyword">if</span>(m == 3) <span class="comment">%DPSS laser</span>
        set(dmbh,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">for</span> m=1:3
    line([1+150*(m) 3+150*(m)], [40 300], <span class="string">'Parent'</span>, ah,<span class="string">'Color'</span>,[0 0 0]);
<span class="keyword">end</span>
uicontrol(<span class="string">'Style'</span>,<span class="string">'pushbutton'</span>,<span class="string">'String'</span>,<span class="string">'Close'</span>,<span class="string">'Position'</span>,[250 3 100 30],<span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8],<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Callback'</span>,{@CloseOptions,fh});
<span class="keyword">end</span>

<span class="keyword">function</span> SetCDRH(src,~,obj)
value = get(src,<span class="string">'Value'</span>);
<span class="keyword">if</span>(value == 0)
    WritePort(obj,<span class="string">'CDRH=0'</span>);
<span class="keyword">else</span>
    WritePort(obj,<span class="string">'CDRH=1'</span>);
<span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> SetDM(src,~,obj)
value = get(src,<span class="string">'Value'</span>);
<span class="keyword">if</span>(value == 1)
    WritePort(obj,<span class="string">'PM=1'</span>);
<span class="keyword">else</span>
    WritePort(obj,<span class="string">'PM=0'</span>);
<span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> CloseOptions(~,~,fh)
delete(fh);
<span class="keyword">end</span>

<span class="keyword">function</span> SelectPorts()
fh = figure(<span class="string">'Name'</span>,<span class="string">'Select COM Ports'</span>,<span class="string">'NumberTitle'</span>,<span class="string">'off'</span>);
scsz = get(0,<span class="string">'ScreenSize'</span>);
set(fh,<span class="string">'Resize'</span>,<span class="string">'off'</span>,<span class="string">'Position'</span>,[50 scsz(4)-200 600 150],<span class="string">'MenuBar'</span>,<span class="string">'none'</span>,<span class="string">'ToolBar'</span>,<span class="string">'none'</span>,<span class="string">'CloseRequestFcn'</span>,@QuitPortSelection);
<span class="comment">%get com port strings</span>
coms = instrhwinfo(<span class="string">'serial'</span>);
comstrings = [{<span class="string">''</span>};coms.AvailableSerialPorts];

nh(1) = uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'405 nm DD'</span>,<span class="string">'Position'</span>,[20 130 130 18],<span class="string">'FontSize'</span>,12,<span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>);
nh(2) = uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'488 nm DD'</span>,<span class="string">'Position'</span>,[20 100 130 18],<span class="string">'FontSize'</span>,12,<span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>);
nh(3) = uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'561 nm DPSS'</span>,<span class="string">'Position'</span>,[20 70 130 18],<span class="string">'FontSize'</span>,12,<span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>);
nh(4) = uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'643 nm DD'</span>,<span class="string">'Position'</span>,[20 40 130 18],<span class="string">'FontSize'</span>,12,<span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>);

ph(1) = uicontrol(<span class="string">'Style'</span>,<span class="string">'popup'</span>,<span class="string">'String'</span>,comstrings,<span class="string">'Position'</span>,[155 130 100 20],<span class="string">'FontSize'</span>,12);
ph(2) = uicontrol(<span class="string">'Style'</span>,<span class="string">'popup'</span>,<span class="string">'String'</span>,comstrings,<span class="string">'Position'</span>,[155 100 100 20],<span class="string">'FontSize'</span>,12);
ph(3) = uicontrol(<span class="string">'Style'</span>,<span class="string">'popup'</span>,<span class="string">'String'</span>,comstrings,<span class="string">'Position'</span>,[155 70 100 20],<span class="string">'FontSize'</span>,12);
ph(4) = uicontrol(<span class="string">'Style'</span>,<span class="string">'popup'</span>,<span class="string">'String'</span>,comstrings,<span class="string">'Position'</span>,[155 40 100 20],<span class="string">'FontSize'</span>,12);

qh(1) = uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'Select a Port'</span>,<span class="string">'Position'</span>,[275 130 310 18],<span class="string">'FontSize'</span>,12,<span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>);
qh(2) = uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'Select a Port'</span>,<span class="string">'Position'</span>,[275 100 310 18],<span class="string">'FontSize'</span>,12,<span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>);
qh(3) = uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'Select a Port'</span>,<span class="string">'Position'</span>,[275 70 310 18],<span class="string">'FontSize'</span>,12,<span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>);
qh(4) = uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'Select a Port'</span>,<span class="string">'Position'</span>,[275 40 310 18],<span class="string">'FontSize'</span>,12,<span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>);

uicontrol(<span class="string">'Style'</span>,<span class="string">'checkbox'</span>,<span class="string">'Position'</span>,[2 128 20 20],<span class="string">'Value'</span>,1,<span class="string">'Callback'</span>,{@ToggleLaser,1,nh,ph,qh});
uicontrol(<span class="string">'Style'</span>,<span class="string">'checkbox'</span>,<span class="string">'Position'</span>,[2 98 20 20],<span class="string">'Value'</span>,1,<span class="string">'Callback'</span>,{@ToggleLaser,2,nh,ph,qh});
uicontrol(<span class="string">'Style'</span>,<span class="string">'checkbox'</span>,<span class="string">'Position'</span>,[2 68 20 20],<span class="string">'Value'</span>,1,<span class="string">'Callback'</span>,{@ToggleLaser,3,nh,ph,qh});
uicontrol(<span class="string">'Style'</span>,<span class="string">'checkbox'</span>,<span class="string">'Position'</span>,[2 38 20 20],<span class="string">'Value'</span>,1,<span class="string">'Callback'</span>,{@ToggleLaser,4,nh,ph,qh});

uicontrol(<span class="string">'Style'</span>,<span class="string">'pushbutton'</span>,<span class="string">'String'</span>,<span class="string">'Confirm'</span>,<span class="string">'Position'</span>,[523 2 75 40],<span class="string">'Callback'</span>,{@ConfirmPorts,ph,fh});

<span class="keyword">for</span> m=1:4
    set(ph(m),<span class="string">'Callback'</span>,{@PortDropDown,qh(m)});
<span class="keyword">end</span>

<span class="keyword">end</span>

<span class="keyword">function</span> PortDropDown(src,~,th)
value = get(src,<span class="string">'Value'</span>);
<span class="keyword">if</span>(value == 1)
    set(th,<span class="string">'String'</span>,<span class="string">'Select a Port'</span>);
    <span class="keyword">return</span>;
<span class="keyword">end</span>
ports = get(src,<span class="string">'String'</span>);
pn = char(ports(value));
obj = OpenPort(pn);
response = WritePort(obj,<span class="string">'?WAVE'</span>);
ClosePort(obj);
<span class="keyword">if</span>(strcmp(response,<span class="string">''</span>))
    set(th,<span class="string">'String'</span>,<span class="string">'Nothing on Port.'</span>);
<span class="keyword">else</span>
    set(th,<span class="string">'String'</span>,[<span class="string">'Wavelength: '</span> response(6:end) <span class="string">' nm'</span>]);
<span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> ConfirmPorts(~,~,ph,fh)
<span class="comment">%check to make sure ports are selected on all active lasers</span>
failed = 0;
laserstring = <span class="string">''</span>;
<span class="keyword">for</span> m=1:4
    <span class="keyword">if</span>(strcmp(get(ph(m),<span class="string">'Enable'</span>),<span class="string">'on'</span>) == 1)
        portvalue(m) = get(ph(m),<span class="string">'Value'</span>);
        <span class="keyword">if</span>(portvalue(m) == 1)
            failed = 1;
            laserstring = [laserstring <span class="string">'Laser '</span> num2str(m) <span class="string">' '</span>];
        <span class="keyword">end</span>
    <span class="keyword">else</span>
        portvalue(m) = 0; <span class="comment">%laser is disabled</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">if</span>(failed)
    errordlg([<span class="string">'The following laser port(s) are not set: '</span> laserstring],<span class="string">'Error'</span>);
    <span class="keyword">return</span>;
<span class="keyword">end</span>
<span class="comment">%also need to confirm the selected lasers are valid.</span>
<span class="comment">%confirm that the same lasers are not selected</span>
<span class="keyword">if</span>(length(nonzeros(portvalue)') ~= length(unique(nonzeros(portvalue)')))
    errordlg(<span class="string">'Lasers cannot have the same port.'</span>);
    <span class="keyword">return</span>;
<span class="keyword">end</span>
comstrs = get(ph(1),<span class="string">'String'</span>);
<span class="keyword">for</span> m=1:4
    portset = get(ph(m),<span class="string">'Value'</span>);
    <span class="keyword">if</span>(portset == 1)
        ports(m) = cellstr(<span class="string">'COM0'</span>);
    <span class="keyword">else</span>
        ports(m) = comstrs(portset);
    <span class="keyword">end</span>
<span class="keyword">end</span>
delete(fh); <span class="comment">%close window</span>
save(<span class="string">'ports.mat'</span>,<span class="string">'ports'</span>);
<span class="keyword">if</span> exist(<span class="string">'settings.mat'</span>, <span class="string">'file'</span>) == 2
    delete(<span class="string">'settings.mat'</span>);
<span class="keyword">end</span>
LoadGUI(ports); <span class="comment">%load the GUI once ports are selected</span>
<span class="keyword">end</span>

<span class="keyword">function</span> ToggleLaser(src,~,number,nh,ph,qh)
onoff = get(src,<span class="string">'Value'</span>);

<span class="keyword">if</span>(onoff == 0)
    set(nh(number),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
    set(ph(number),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
    set(qh(number),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
<span class="keyword">else</span>
    set(nh(number),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
    set(ph(number),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
    set(qh(number),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
<span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> QuitPortSelection(src,~)
choice = questdlg({<span class="string">'Do you want to exit?'</span>,<span class="string">'Changes will not be saved!'</span>},<span class="string">'Confirm Exit'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
<span class="keyword">switch</span> choice
    <span class="keyword">case</span> <span class="string">'Yes'</span>
        <span class="comment">%close ports?</span>
        delete(src);
    <span class="keyword">case</span> <span class="string">'No'</span>
        <span class="keyword">return</span>
<span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> response = WritePort(obj,string)
response = query(obj,string',<span class="string">'%s\n'</span>,<span class="string">'%s'</span>);
<span class="keyword">end</span>

<span class="keyword">function</span> obj = OpenPort(port)
obj = serial(port,<span class="string">'BaudRate'</span>,9600,<span class="string">'Parity'</span>,<span class="string">'none'</span>,<span class="string">'DataBits'</span>,8,<span class="string">'StopBits'</span>,1,<span class="string">'FlowControl'</span>,<span class="string">'none'</span>,<span class="string">'Terminator'</span>,<span class="string">'CR/LF'</span>);
fopen(obj);
<span class="keyword">end</span>

<span class="keyword">function</span> ClosePort(obj)
fclose(obj);
delete(obj);
<span class="keyword">end</span>
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014b</a><br></p></div><!--
##### SOURCE BEGIN #####
function ExcelsiorOne()
%check to see if the port settings are set
if exist('ports.mat', 'file') == 2
    ports = load('ports.mat');
    LoadGUI(ports.ports);
else
    SelectPorts();
end
end

function LoadGUI(ports)
fh = figure('Name','Spectra-Physics Excelsior One Control','NumberTitle','off');
set(fh,'Resize','off','Position',[50 50 600 300],'MenuBar','none','ToolBar','none');
ah = axes;
set(ah,'Visible','off','Position',[0 0 1 1],'Xlim',[0 600],'Ylim',[0 300]);
mh = uimenu(fh,'Label','Options');
moh(1) = uimenu(mh,'Label','Options');
moh(2) = uimenu(mh,'Label','Save Powers');



%Open the COM ports
%Get the wavelength, min and max powers for each laser
for m=1:4
    pn = char(ports(m));
    if(strcmp(pn,'COM0') ~= 1)
        obj = OpenPort(pn);
        r = WritePort(obj,'?WAVE');
        wl = str2double(r(6:end));
        WritePort(obj,'LD=0'); %start with laser off
        if(m == 3)
            MinPwr = 50;
        else
            r = WritePort(obj,'?MINLP');
            MinPwr = str2double(r(7:end));
        end
        r = WritePort(obj,'?MAXLP');
        MaxPwr = str2double(r(7:end));
        r = WritePort(obj,'?SP');
        Pwr = str2double(r(4:end));
    else
        wl = 0; %change to read from COM
        obj = serial('COM1');
        MinPwr = 0; MaxPwr = 100; Pwr = 100;
    end
    nh = uicontrol('Style','text','String',{[pn ':'],[num2str(wl) ' nm']},'Position',[5+150*(m-1) 255 140 40],'FontSize',10,'FontWeight','bold');
    bh = uicontrol('Style','togglebutton','String','Laser Off','Position',[25+150*(m-1) 240 100 20],'FontSize',10,'FontWeight','bold','BackgroundColor',[0.8 0.8 0.8],'Callback',{@LaserOnOff,m,obj});
    cpth(m) = uicontrol('Style','text','String',['Power: ' num2str(Pwr) ' mW'],'Position',[5+150*(m-1) 215 140 20],'FontSize',10,'FontWeight','bold');
    pth = uicontrol('Style','text','String',[num2str(Pwr) ' mW'],'Position',[25+150*(m-1) 72 60 20],'FontSize',10);
    sph = uicontrol('Style','slider','Position',[90+150*(m-1) 30 30 180],'Min',MinPwr,'Max',MaxPwr,'Value',Pwr,'BackgroundColor',[0.8 0.8 0.8],'Callback',{@ChangePower,pth,obj});
    mapth = uicontrol('Style','text','String',[num2str(MaxPwr) ' mW'],'Position',[25+150*(m-1) 190 60 20],'FontSize',10);
    mipth = uicontrol('Style','text','String',[num2str(MinPwr) ' mW'],'Position',[2